---
import Layout from '../components/Layout.astro';
import Navigation from '../components/Navigation.astro';
import PrerequisiteBar from '../components/PrerequisiteBar.astro';
import ProgressTracker from '../components/ProgressTracker.astro';
import RelatedContent from '../components/RelatedContent.astro';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  description: string;
  section: string;
  order: number;
  prerequisites?: string[];
  relatedPages?: string[];
  prev?: string;
  next?: string;
  tags?: string[];
}

const {
  title,
  description,
  section,
  order,
  prerequisites = [],
  relatedPages = [],
  prev,
  next,
} = Astro.props;

const stripExt = (id: string) => id.replace(/\.mdx?$/, '');
const currentSlug = Astro.url.pathname.replace(/^\//, '').replace(/\/$/, '');
const allPages = await getCollection('pages');
const totalPages = allPages.length;
const allSorted = allPages.sort((a, b) => {
  const sectionOrder = ['foundation', 'retrieval-strategies', 'graph-rag', 'rag-ontology', 'synthesis'];
  const sa = sectionOrder.indexOf(a.data.section);
  const sb = sectionOrder.indexOf(b.data.section);
  if (sa !== sb) return sa - sb;
  return a.data.order - b.data.order;
});
const currentIndex = allSorted.findIndex(p => stripExt(p.id) === currentSlug);

const sectionLabels: Record<string, string> = {
  'foundation': 'Foundation',
  'retrieval-strategies': 'Retrieval Strategies',
  'graph-rag': 'Graph-Based RAG',
  'rag-ontology': 'RAG Ontology',
  'synthesis': 'Synthesis',
};

const prevPage = prev ? allPages.find(p => stripExt(p.id) === prev) : undefined;
const nextPage = next ? allPages.find(p => stripExt(p.id) === next) : undefined;

const relatedPageData = relatedPages
  .map(slug => allPages.find(p => stripExt(p.id) === slug))
  .filter((p): p is NonNullable<typeof p> => p !== undefined);
---
<Layout title={title} description={description}>
  <div class="site-layout">
    <Navigation currentSlug={currentSlug} currentSection={section} />
    <main class="site-content">
      <ProgressTracker
        currentIndex={currentIndex >= 0 ? currentIndex : 0}
        totalPages={totalPages}
        sectionName={sectionLabels[section] || section}
      />
      <PrerequisiteBar prerequisites={prerequisites} />
      <h1>{title}</h1>
      <slot />

      <RelatedContent
        nextPage={nextPage ? {
          href: `/${stripExt(nextPage.id)}`,
          title: nextPage.data.title,
          description: nextPage.data.description
        } : undefined}
        prevPage={prevPage ? {
          href: `/${stripExt(prevPage.id)}`,
          title: prevPage.data.title,
          description: prevPage.data.description
        } : undefined}
        relatedPages={relatedPageData.map(p => ({
          href: `/${stripExt(p.id)}`,
          title: p.data.title,
          description: p.data.description
        }))}
      />
    </main>
  </div>
</Layout>
